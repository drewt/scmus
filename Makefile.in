prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
bindir = @bindir@
datadir = @datadir@
mandir = @mandir@

_ver0   = $(shell git rev-parse --verify --short HEAD 2>/dev/null)-git
_ver1   = @PACKAGE_VERSION@
VERSION = $(or $(_ver0),$(_ver1))

LIBS = @NCURSES_LIBS@

features-@CONFIG_WIDE_CHAR@ += -feature wide-char

types-cflags-$(typed) = -types all.types
types-prereq-$(typed) = all.types

prelude = '"(define *scmus-dir* \"$(datadir)/scmus\")\
	    (define *version*   \"$(VERSION)\")"'

CSC      = csc
TFLAGS   = -uses lib -prologue prologue.scm $(features-y) 
CSCFLAGS = -scrutinize -C -Wno-int-to-pointer-cast -C -Wno-cpp $(TFLAGS) \
	   $(types-cflags-y)
LD       = csc
LDFLAGS  =
INSTALL  = @scripts/install

eggs = coops sandbox unix-sockets utf8

units = bindings-view browser-view config command-line editable eval-mode \
	event format getopt input iter key-table keys lib library-view \
	mpd-client ncurses option options-view queue-view search-view \
	scmus-client ui-curses ui-lib view window
objects = $(foreach unit,$(units),$(addsuffix .@OBJEXT@,$(unit)))
types   = $(foreach unit,$(units),$(addsuffix .types,$(unit)))
target = scmus@EXEEXT@

test-units = test/iter
test-objects = $(foreach unit,$(test-units),$(addsuffix .@OBJEXT@,$(unit)))

clean = $(objects) main.@OBJEXT@ $(test-objects) check.@OBJEXT@ $(types) \
	$(target) all.types

all: $(target)

include rules.mk

config.o: CSCFLAGS += -prelude $(prelude)

$(objects): prologue.scm $(types-prereq-y)

$(target): $(objects) main.@OBJEXT@
	$(call cmd,ld,$(LIBS))

$(test-objects): prologue.scm test/test.scm

check: $(objects) $(test-objects) check.@OBJEXT@
	$(call cmd,ld,$(LIBS))

all.types: $(types)
	$(call cmd,cat)

eggs:
	chicken-install $(eggs)

install: all
	$(INSTALL) -m755 $(bindir) scmus
	$(INSTALL) -m644 $(datadir)/scmus data/scmusrc.scm
	$(INSTALL) -m644 $(datadir)/scmus/colors $(wildcard data/colors/*)
	$(INSTALL) -m644 $(mandir)/man1 $(wildcard doc/*.1)
